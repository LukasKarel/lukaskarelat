name: Deploy
run-name: Deploy to ${{ inputs.environment }} by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - prod

concurrency:
  group: ${{inputs.environment}}
  cancel-in-progress: false

jobs:
  build-frontend:
    permissions:
      contents: read
      id-token: write
    uses: ./.github/workflows/build_static_sites.yml
    with:
      hostname: ${{ vars.HOST_DOMAIN }}
      environment: ${{inputs.environment}}

  deploy-site:
    needs: build-frontend
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ vars.HOST_DOMAIN }}
    steps:
    - name: Checkout
      uses: actions/checkout@v5
    - name: Download static site
      uses: actions/download-artifact@v4
      with:
        artifact-ids: ${{ needs.build-frontend.outputs.website-artifict-id }}
        path: ./deploy/lukaskarelat
        merge-multiple: true

    - name: Setup Caddyfile
      uses: cuchi/jinja2-action@8bd801365a8d36a0b20f45ee969161685de7785a
      with:
        template: ./src/backend/caddy/Caddyfile.j2
        output_file: ./src/backend/caddy/lukaskarelat.caddy
        strict: true
        variables: |
          HOST_DOMAIN=${{vars.HOST_DOMAIN}}
          WWW_HOST_DOMAIN=${{vars.WWW_HOST_DOMAIN}}

    - name: Create tar archive
      run: |
          mkdir -p dist/tar
          cp -r deploy/lukaskarelat dist/tar/site
          cp src/backend/caddy/lukaskarelat.caddy dist/tar/caddy

          tar -czf dist/archive.tar.gz \
              -C dist/tar .
    
    - name: Publish archive
      uses: appleboy/scp-action@7179e72a3fa4d4c33870a471708fda724fae7596
      with:
        host: ${{ secrets.DEPLOY_SSH_HOST }}
        username: ${{ secrets.DEPLOY_SSH_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        source: "dist/archive.tar.gz"
        target: /tmp/lukaskarelat
        rm: true
        strip_components: 1

    - name: Deploy
      uses: appleboy/ssh-action@3ca8a7c5359ac6ad91aa47f1946ece1c3b025004
      with:
        host: ${{ secrets.DEPLOY_SSH_HOST }}
        username: ${{ secrets.DEPLOY_SSH_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        script: |
          # next line is required that script fails if one command returns non-zero return code
          set -e

          rm -rf /tmp/lukaskarelat/ext
          mkdir -p /tmp/lukaskarelat/ext /srv/sites/lukaskarelat
          tar -xvf /tmp/lukaskarelat/archive.tar.gz -C /tmp/lukaskarelat/ext

          rsync --delete -r /tmp/lukaskarelat/ext/site/ /srv/sites/lukaskarelat
          cp /tmp/lukaskarelat/ext/caddy /srv/stacks/proxy/caddy-cfg/lukaskarelat.caddy

          # required -lc that login is triggered and reload function should be loaded then
          bash -lc "reload_proxy_config"

