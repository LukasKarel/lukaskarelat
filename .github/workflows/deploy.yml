name: Deploy
run-name: Deploy to ${{ inputs.environment }} by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - prod

concurrency:
  group: ${{inputs.environment}}
  cancel-in-progress: false

jobs:
  build-frontend:
    permissions:
      contents: read
      id-token: write
    uses: ./.github/workflows/build_static_sites.yml
    with:
      hostname: ${{ vars.HOST_DOMAIN }}
      environment: ${{inputs.environment}}

  deploy-static-site:
    needs: build-frontend
    runs-on: ubuntu-latest
    steps:
    - name: Download static site
      uses: actions/download-artifact@v4
      with:
        artifact-ids: ${{ needs.build-frontend.outputs.website-artifict-id }}
        path: ./site


    - name: Verify content
      run: ls -lah ./site


    - name: Copy files via SSH
      uses: appleboy/scp-action@7179e72a3fa4d4c33870a471708fda724fae7596
      with:
        host: ${{ secrets.DEPLOY_SSH_HOST }}
        username: ${{ secrets.DEPLOY_SSH_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        source: "./site"
        target: /srv/sites/lukaskarelat

