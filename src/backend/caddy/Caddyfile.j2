{% if WWW_HOST_DOMAIN %}

{{WWW_HOST_DOMAIN}} {
    redir {{HOST_DOMAIN}}{uri} permanent
}

{% endif %}

{{HOST_DOMAIN}} {

    rate_limit {
        zone dynamic_example {
            match {
                path /api/newsletter/subscribe
            }
            key    {client_ip}
            events 5
            window 1h
        }
    }

    # newsletter api forwarding
    route /api/newsletter/* {
        

        reverse_proxy {{NEWSLETTER_API_PROXY_HOST}}
    }

    root * /srv/sites/lukaskarelat
	file_server

	# Serve 404.html for any missing file
	handle_errors {
		@notFound {
			expression {http.error.status_code} == 404
		}
		rewrite @notFound /404.html
		file_server
	}
}

{{LISTMONK_HOST_DOMAIN}} {
    # for seo reasons forward root to /archive
	@root path /
	redir @root /archive 302

    @restricted path_regexp restricted ^/(admin|api)

    # Deny if restricted and NOT from Tailscale
    handle @restricted {
            @not_tailscale not client_ip 100.64.0.0/10
            respond @not_tailscale 403
    }    

    reverse_proxy {{LISTMONK_PROXY_HOST}}
}